name: Sync Upstream and Release

on:
  schedule:
    - cron: "0 0/4 * * *"
  push:
    branches: ["develop", "main"]
  pull_request:
    branches: ["develop"]
  release:
    types: [published]
  workflow_dispatch:
  repository_dispatch:
    types:
      - sync_update

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    concurrency:
      group: hourly-sync
      cancel-in-progress: true
    outputs:
      merge_succeeded: ${{ steps.merge_upstream.conclusion == 'success' }}
      has_non_workflow_changes: ${{ steps.merge_upstream.outputs.has_non_workflow_changes }}
    permissions:
      contents: write
      pull-requests: write  # æ·»åŠ  PR åˆ›å»ºæƒé™
      actions: write  # æ­£ç¡®çš„å·¥ä½œæµç®¡ç†æƒé™

    steps:
      - name: è®¾ç½®æ—¶åŒº
        run: sudo timedatectl set-timezone Asia/Shanghai

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½®Gitç”¨æˆ·
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: è·å–è¿œç¨‹ä»“åº“ä¿¡æ¯
        run: |
          git remote add upstream https://github.com/Fansirsqi/Sesame-TK.git || true
          git fetch upstream

      - name: æ£€æŸ¥å¹¶åˆå¹¶ä¸Šæ¸¸æ›´æ–°
        id: merge_upstream
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # æ£€æŸ¥åˆ†æ”¯å·®å¼‚
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse upstream/main)
          BASE=$(git merge-base $LOCAL $REMOTE)
          LOCAL_AHEAD=$(git rev-list --count $BASE..$LOCAL)
          REMOTE_AHEAD=$(git rev-list --count $BASE..$REMOTE)

          echo "=== åˆ†æ”¯å·®å¼‚è¯¦æƒ… ==="
          echo "æœ¬åœ°æäº¤: $LOCAL"
          echo "ä¸Šæ¸¸æäº¤: $REMOTE"
          echo "å…±åŒç¥–å…ˆ: $BASE"
          echo "æœ¬åœ°é¢†å…ˆ: $LOCAL_AHEAD ä¸ªæäº¤"
          echo "ä¸Šæ¸¸é¢†å…ˆ: $REMOTE_AHEAD ä¸ªæäº¤"
          echo "=== å·®å¼‚æ–‡ä»¶åˆ—è¡¨ ==="
          git diff $LOCAL $REMOTE --name-only

          # åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
          if [ "$LOCAL_AHEAD" -gt "0" ] && [ "$REMOTE_AHEAD" -gt "0" ]; then
            has_update=true
          elif [ "$REMOTE_AHEAD" -gt "0" ]; then
            has_update=true
          else
            has_update=false
          fi
          echo "has_update=$has_update" >> $GITHUB_OUTPUT
          echo "has_update=$has_update" >> $GITHUB_ENV
          
          # åˆå¹¶ä¸Šæ¸¸æ›´æ–°
          if [ "$has_update" == 'true' ]; then  # å¤–å±‚å·²åˆ¤æ–­ä¸Šæ¸¸æœ‰æ›´æ–°
            git fetch upstream main && git fetch origin main || exit 1
            git branch -D temp-merge-branch 2>/dev/null || true
            git checkout -b temp-merge-branch
            # æ‹‰å–æœ€æ–°ä»£ç å¹¶å˜åŸºï¼Œç¡®ä¿æœ¬åœ°åˆ†æ”¯æœ€æ–°
            if ! git pull origin main --rebase; then
              echo "merge_succeeded=false" >> $GITHUB_OUTPUT
              echo "=== æ‹‰å–ä»£ç å¤±è´¥ ==="
              git status
              exit 1
            fi
            
            # æ‰§è¡Œåˆå¹¶å¹¶æ£€æŸ¥ç»“æœ
            echo "=== å¼€å§‹åˆå¹¶ä¸Šæ¸¸ä»£ç  ==="
            ##if git merge upstream/main --no-commit --no-ff -X ours; then
            if git merge upstream/main --no-commit --no-ff; then
              echo "merge_succeeded=true" >> $GITHUB_OUTPUT
              echo "=== åˆå¹¶æˆåŠŸï¼Œå˜æ›´æ–‡ä»¶åˆ—è¡¨ ==="
              git diff --name-only
              # æ’¤é”€å·¥ä½œæµæ–‡ä»¶å˜æ›´ï¼ˆé¿å…éœ€è¦workflowsæƒé™ï¼‰
              git checkout -- .github/workflows/
              # æ–°å¢ï¼šé‡ç½®æš‚å­˜åŒºï¼Œç¡®ä¿å·¥ä½œæµæ–‡ä»¶å˜æ›´ä¸è¢«æäº¤
              git reset HEAD .github/workflows/
              # æ·»åŠ æäº¤æ­¥éª¤ï¼ˆæ­¤æ—¶ä¸åŒ…å«å·¥ä½œæµæ–‡ä»¶å˜æ›´ï¼‰
              git commit -m "Merge upstream changes (excluding workflow files)"
                # æ£€æŸ¥æ˜¯å¦æœ‰éå·¥ä½œæµæ–‡ä»¶çš„å˜æ›´
              NON_WORKFLOW_CHANGES=$(git diff --name-only $BASE..$REMOTE | grep -v '^\.github/workflows/' | wc -l)
              if [ $NON_WORKFLOW_CHANGES -gt 0 ]; then
                echo "has_non_workflow_changes=true" >> $GITHUB_OUTPUT
              else
                echo "has_non_workflow_changes=false" >> $GITHUB_OUTPUT
              fi
              # æ¨é€åˆå¹¶ç»“æœ
              git push origin temp-merge-branch:main
            else
              echo "merge_succeeded=false" >> $GITHUB_OUTPUT
              echo "=== åˆå¹¶å¤±è´¥è¯¦æƒ… ==="
              git status
              git diff
              exit 1
            fi
          else
            # ä¸Šæ¸¸æ— æ›´æ–°æ—¶ç›´æ¥æ ‡è®°æ— å˜æ›´
            echo "=== ä¸Šæ¸¸æ— æ›´æ–° ==="
            echo "merge_succeeded=false" >> $GITHUB_OUTPUT
            echo "has_non_workflow_changes=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: false

  build-and-release:
    needs: sync-upstream
    runs-on: ubuntu-latest
    if: needs.sync-upstream.outputs.merge_succeeded == 'true' && needs.sync-upstream.outputs.has_non_workflow_changes == 'true'

    steps:
      - name: è®¾ç½®æ—¶åŒºä¸ºäºšæ´²/ä¸Šæµ·
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "å½“å‰æ—¶é—´: $(date)"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½®JDKç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          java-version: "23"
          distribution: "zulu"
          cache: gradle

      - name: é…ç½®Gradleç¯å¢ƒ
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          gradle-version: wrapper

      - name: æˆäºˆgradlewæ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: ä½¿ç”¨Gradleæ„å»º
        run: ./gradlew assembleNormalRelease assembleCompatibleRelease -Pversion=${{ github.ref_name }} --parallel

      - name: å®šä½APKæ–‡ä»¶å¹¶è®¾ç½®è¾“å‡º
        id: locate_apks
        run: |
          normal_apk=$(find app/build/outputs/apk/normal/release -name "*.apk" | head -n 1)
          compatible_apk=$(find app/build/outputs/apk/compatible/release -name "*.apk" | head -n 1)
          echo "normal_apk=$normal_apk" >> $GITHUB_OUTPUT
          echo "compatible_apk=$compatible_apk" >> $GITHUB_OUTPUT

      - name: å‡†å¤‡ç­¾åç›®å½•å¹¶å¤åˆ¶APK
        run: |
          # åˆ›å»ºAPKåˆå¹¶ç›®å½•
          mkdir -p app/build/outputs/apk/all
          # å¤åˆ¶Normalç‰ˆæœ¬APK
          cp ${{ steps.locate_apks.outputs.normal_apk }} app/build/outputs/apk/all/
          # å¤åˆ¶Compatibleç‰ˆæœ¬APK
          cp ${{ steps.locate_apks.outputs.compatible_apk }} app/build/outputs/apk/all/

      - name: ç­¾åAPKæ–‡ä»¶
        id: sign_apks
        uses: ilharp/sign-android-release@v2
        with:
          releaseDir: app/build/outputs/apk/all
          signingKey: ${{ secrets.ANDROID_SIGNING_KEY }}
          keyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
          buildToolsVersion: 36.0.0
          
      - name: æå–å·²ç­¾åAPKè·¯å¾„
        id: extract_apks
        run: |
          IFS=':' read -r -a files <<< "${{ steps.sign_apks.outputs.signedFiles }}"
          for file in "${files[@]}"; do
            if [[ "$file" == *Normal* ]]; then
              echo "signed_normal=$file" >> $GITHUB_OUTPUT
              echo "æ‰¾åˆ°Normal APK: $file"
            elif [[ "$file" == *Compatible* ]]; then
              echo "signed_compatible=$file" >> $GITHUB_OUTPUT
              echo "æ‰¾åˆ°Compatible APK: $file"
            fi
          done
          # æ·»åŠ è°ƒè¯•è¾“å‡ºä»¥éªŒè¯å˜é‡æ˜¯å¦è¢«æ­£ç¡®è®¾ç½®
          echo "ç­¾åæ–‡ä»¶åˆ—è¡¨: ${{ steps.sign_apks.outputs.signedFiles }}"

      - name: ç”ŸæˆAPKæ ¡éªŒå’Œ
        run: |
          sha256sum ${{ steps.extract_apks.outputs.signed_normal }} > CHECKSUMS-Sesame-Normal-${{ steps.extract_info.outputs.version }}.${{ env.SHORT_SHA }}-signed.apk.sha256
          sha256sum ${{ steps.extract_apks.outputs.signed_compatible }} > CHECKSUMS-Sesame-Compatible-${{ steps.extract_info.outputs.version }}.${{ env.SHORT_SHA }}-signed.apk.sha256

      - name: æŸ¥æ‰¾æœ‰æ•ˆæäº¤ä»¥ç”Ÿæˆé€šçŸ¥
        id: find_valid_commit
        run: |
          # ä½¿ç”¨git logä¸€æ¬¡æ€§è·å–æœ€è¿‘10æ¬¡æäº¤è®°å½•
          # æ ¼å¼: æäº¤å“ˆå¸Œ<åˆ†éš”ç¬¦>ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
          COMMITS=$(git log -n 10 --pretty=format:"%H<COMMIT_SEP>" --name-only ${{ github.sha }})

          # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªä¸åªä¿®æ”¹å·¥ä½œæµæ–‡ä»¶çš„æäº¤
          VALID_COMMIT=$(echo "$COMMITS" | awk -v RS="<COMMIT_SEP>" '{
            if (NF == 0) next;  # è·³è¿‡ç©ºè®°å½•
            hash=$1; files=substr($0, length(hash)+2);
            if (files !~ /^\.github\/workflows\/sync-and-release\.yml$/ || NF > 1) {
              print hash; exit;
            }
          }')

          # ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„æäº¤å“ˆå¸Œ
          COMMIT_HASH=${VALID_COMMIT:-${{ github.sha }}}
          SHORT_COMMIT_HASH=$(echo "$COMMIT_HASH" | cut -c1-8)

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "SHORT_COMMIT_HASH=$SHORT_COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=$SHORT_COMMIT_HASH" >> $GITHUB_ENV

          echo "ä½¿ç”¨çš„æäº¤å“ˆå¸Œ: $COMMIT_HASH (çŸ­å“ˆå¸Œ: $SHORT_COMMIT_HASH)"

      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: extract_info
        run: |
          # ä»build.gradle.ktsæå–ç‰ˆæœ¬å·ç»„ä»¶
          MAJOR=$(grep -oP 'val major = \K\d+' app/build.gradle.kts)
          MINOR=$(grep -oP 'val minor = \K\d+' app/build.gradle.kts)
          PATCH=$(grep -oP 'val patch = \K\d+' app/build.gradle.kts)
          BUILD_TAG=$(grep -oP 'val buildTag = "\K[^"]+' app/build.gradle.kts)
          
          # ç»„åˆå®Œæ•´ç‰ˆæœ¬å·
          VERSION="$MAJOR.$MINOR.$PATCH-$BUILD_TAG"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "æå–åˆ°ç‰ˆæœ¬å·: $VERSION"

      - name: ä»ç‰ˆæœ¬åˆ›å»ºæ ‡ç­¾
        if: (startsWith(github.ref, 'refs/heads/main') && github.event_name == 'push') || github.event_name == 'release'
        run: |
          VERSION_TAG="v${{ steps.extract_info.outputs.VERSION }}"
          echo "åˆ›å»ºæ ‡ç­¾: $VERSION_TAG"
          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™è·³è¿‡
          if git rev-parse "$VERSION_TAG" >/dev/null 2>&1; then
            echo "æ ‡ç­¾ $VERSION_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            git tag "$VERSION_TAG"
            git push origin "$VERSION_TAG"
          fi

      - name: ä¸Šä¼ å‘å¸ƒèµ„äº§
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.event.release.tag_name || format('v{0}', steps.extract_info.outputs.VERSION) }}
          tag_name: ${{ github.event.release.tag_name || format('v{0}', steps.extract_info.outputs.VERSION) }}
          body: |
            ğŸ“¦ *New Version ${{ github.ref_name }} Build!*
            (Commit: [${{ env.SHORT_SHA }}](https://github.com/${{ github.repository }}/commit/${{ steps.find_valid_commit.outputs.COMMIT_HASH || github.sha }}))

            *ä¸‹è½½è¯´æ˜:*
              * Normal ä¸ºæ­£å¸¸ç‰ˆæœ¬,é€‚ç”¨äº`Android 8.0`åŠä»¥ä¸Šçš„ç³»ç»Ÿã€‚
              * Compatible ä¸ºå…¼å®¹ç‰ˆæœ¬,é€‚ç”¨äº`Android 7.0`åŠä»¥ä¸‹çš„ç³»ç»Ÿ,æœ€ä½æ”¯æŒ`Android 5.1`
          files: |
            ${{ steps.extract_apks.outputs.signed_compatible }}
            ${{ steps.extract_apks.outputs.signed_normal }}
            CHECKSUMS-Sesame-Normal-${{ steps.extract_info.outputs.version }}.${{ env.SHORT_SHA }}-signed.apk.sha256
            CHECKSUMS-Sesame-Compatible-${{ steps.extract_info.outputs.version }}.${{ env.SHORT_SHA }}-signed.apk.sha256
            # ä½¿ç”¨å¸¦vå‰ç¼€çš„æ ‡ç­¾åç§°,ä¸åˆ›å»ºæ ‡ç­¾æ­¥éª¤ä¿æŒä¸€è‡´
            tag_name: ${{ github.event.release.tag_name || format('v{0}', steps.extract_info.outputs.version) }}
            draft: false
            prerelease: false
            generate_release_notes: true
