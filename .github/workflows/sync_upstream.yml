name: Sync Upstream & Merge

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时触发
  workflow_dispatch:       # 支持手动触发

jobs:
  sync-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout local repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/Ziayongyao/Sesame-TK || true
        git fetch upstream
        
    - name: Check common ancestor
      id: check_ancestor
      run: |
        if git merge-base --is-ancestor upstream/main main 2>/dev/null; then
          echo "Has common ancestor"
          exit 0
        else
          echo "No common ancestor"
          exit 1
        fi
        
    - name: Check for new commits (excluding workflows)
      id: check_changes
      run: |
        CHANGES=$(git diff --name-only upstream/main main | grep -v '^\.github/workflows/')
        if [ -n "$CHANGES" ]; then
          echo "New changes detected"
          echo "changes=$CHANGES" >> $GITHUB_ENV
          exit 0
        else
          echo "No relevant changes"
          exit 1
        fi
        
    - name: Merge upstream changes
      if: steps.check_changes.conclusion == 'success'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # 合并时保留本地工作流文件
        git merge --no-commit upstream/main
        git checkout main -- .github/workflows/*
        git commit -m "Merge upstream changes, keeping local workflows"
        
    - name: Trigger build release workflow
      if: success()
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        event-type: "build_release"
