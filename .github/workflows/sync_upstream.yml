# åŒæ­¥ä¸Šæ¸¸ä»“åº“å·¥ä½œæµ
name: ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»“åº“

on:
  # æ¯6å°æ—¶è‡ªåŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# åœ¨å…¨å±€ç¯å¢ƒå˜é‡ä¸­æ·»åŠ ä¸Šæ¸¸ä»“åº“åœ°å€
env:
  UPSTREAM_REPO: Ziayongyao/Sesame-TK  # ä¿®æ”¹æ­¤è¡Œå³å¯æ›´æ–°æ‰€æœ‰å…³è”é…ç½®

jobs:
  sync-check:
    runs-on: ubuntu-latest
    name: ğŸ” åŒæ­¥æ£€æŸ¥
    
    outputs:
      new_commit: ${{ steps.check_new.outputs.new_commit }}  # å®šä¹‰Jobè¾“å‡º
    
    steps:
      - name: ğŸ“¦ æ£€å‡ºæœ¬åœ°ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: ğŸ› ï¸ è®¾ç½® Git æƒé™
        run: |
          git config --global user.name "Sesame-TK Bot"
          git config --global user.email "bot@sesame-tk.com"
        # ä¸­æ–‡æ³¨é‡Šï¼šé…ç½® Git ç”¨æˆ·ä¿¡æ¯

      - name: ğŸ“¥ è·å–æœ¬åœ°æäº¤è®°å½•
        run: |
          git log --pretty=format:"%H" > local_hashes.txt
          echo "æœ¬åœ°æäº¤è®°å½•å·²ä¿å­˜"
        # ä¸­æ–‡æ³¨é‡Šï¼šè·å–æœ¬åœ° Git æäº¤å†å²è®°å½•ç”¨äºæ¯”å¯¹

      - name: ğŸŒ è·å–ä¸Šæ¸¸æœ€æ–°æäº¤
        id: get_upstream
        run: |
          # ä½¿ç”¨ç¯å¢ƒå˜é‡æ„å»º API è¯·æ±‚è·¯å¾„
          response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/commits")
          latest_hash=$(echo $response | jq -r '.[0].sha')
          echo "latest_hash=$latest_hash" >> $GITHUB_ENV
          echo "è·å–ä¸Šæ¸¸æœ€æ–°æäº¤: $latest_hash"

      - name: ğŸ” æ£€æŸ¥æ–°æäº¤
        id: check_new
        run: |
          # æ£€æŸ¥ä¸Šæ¸¸å“ˆå¸Œæ˜¯å¦å­˜åœ¨äºæœ¬åœ°
          if grep -q "$latest_hash" local_hashes.txt; then
            echo "æ— éœ€åŒæ­¥ï¼Œå·²åœ¨æœ¬åœ°å­˜åœ¨"
            echo "new_commit=false" >> $GITHUB_OUTPUT  # æ˜ç¡®è¾“å‡ºfalse
          else
            echo "å‘ç°æ–°æäº¤ï¼Œç»§ç»­æ‰§è¡Œ"
            echo "new_commit=true" >> $GITHUB_OUTPUT  # è¾“å‡ºtrue
          fi
        # ä¸­æ–‡æ³¨é‡Šï¼šæ¯”å¯¹æœ¬åœ°ä¸ä¸Šæ¸¸æäº¤å“ˆå¸Œ

  merge-workflow:
    runs-on: ubuntu-latest
    name: ğŸ”„ åˆ†æ”¯åˆå¹¶
    needs: sync-check
    #if: ${{ needs.sync-check.outputs.new_commit == 'true' }}  # æ­£ç¡®ä½¿ç”¨Job Output
    permissions:
      contents: write  # å…è®¸è§¦å‘å·¥ä½œæµ
    
    steps:
      - name: ğŸ“¦ æ£€å‡ºä¸»åˆ†æ”¯
        uses: actions/checkout@v3
        with:
          ref: main
          path: main-branch  # æ˜¾å¼å£°æ˜è·¯å¾„

      - name: ğŸ§© æ£€å‡ºä¸Šæ¸¸åˆ†æ”¯
        uses: actions/checkout@v3
        with:
          repository: ${{ env.UPSTREAM_REPO }}  # ä½¿ç”¨ç¯å¢ƒå˜é‡
          ref: main
          path: upstream-branch
          fetch-depth: 0

      - name: ğŸ”€ åˆå¹¶ä¸Šæ¸¸æ”¹åŠ¨
        run: |
          # å®šä¹‰è·¯å¾„å¸¸é‡
          MAIN_PATH=$GITHUB_WORKSPACE/main-branch
          UPSTREAM_PATH=$GITHUB_WORKSPACE/upstream-branch
          
          # è¿›å…¥ä¸»åˆ†æ”¯ç›®å½•
          cd $MAIN_PATH
          
          # è®¾ç½®æœ¬åœ° Git ç”¨æˆ·ä¿¡æ¯
          git config --local user.name "Sesame-TK Bot"
          git config --local user.email "bot@sesame-tk.com"
          
          # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
          git remote add upstream file://$UPSTREAM_PATH
          
          # è·å–ä¸Šæ¸¸å®Œæ•´å†å²
          git fetch upstream +refs/heads/*:refs/remotes/upstream/*
          
          # åˆ›å»ºè·Ÿè¸ªåˆ†æ”¯
          git checkout -b upstream-main upstream/main
          
          # å›åˆ°ä¸»åˆ†æ”¯
          git checkout main
          
          # æ‰§è¡Œåˆå¹¶ï¼ˆå…è®¸æ— å…³å†å² + è‡ªåŠ¨å†²çªè§£å†³ï¼‰
          git merge --no-commit --allow-unrelated-histories \
            -s recursive -X ours upstream-main
          
          # å¼ºåˆ¶ä¿ç•™æœ¬åœ°å·¥ä½œæµæ–‡ä»¶ï¼ˆå…³é”®ä¿æŠ¤ï¼‰
          git checkout main -- .github/workflows/*
          
          # æäº¤åˆå¹¶ç»“æœ
          git commit -m "Merge upstream changes, keep local workflows"
          
          # æ¨é€åˆå¹¶ç»“æœ
          git push origin main
        # ä¸­æ–‡æ³¨é‡Šï¼šä½¿ç”¨ recursive + X ours ç­–ç•¥è§£å†³å†²çª

      - name: ğŸš€ è§¦å‘æ„å»ºæµç¨‹
        #if: success()
        run: |
          # å¢åŠ è°ƒè¯•ä¿¡æ¯è¾“å‡º
          echo "å½“å‰ä»“åº“: ${{ github.repository }}"
          echo "è¯·æ±‚ä»¤ç‰ŒçŠ¶æ€: ${{ secrets.GITHUB_TOKEN != '' }}"
          
          # è§¦å‘æœ¬åœ°build_release.ymlå·¥ä½œæµ
          response=$(curl -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.github+json" \
            --data '{"ref":"main","event_type":"workflow_dispatch"}' \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/build_release.yml/dispatches")
          
          # è¾“å‡ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯
          echo "è§¦å‘æ„å»ºåŸå§‹å“åº”: $response"
          echo "HTTPçŠ¶æ€ç : $?"
          
          # æ”¹è¿›çŠ¶æ€åˆ¤æ–­é€»è¾‘
          if [[ "$response" == *"204"* || $? -eq 0 ]]; then
            echo "âœ… æˆåŠŸè§¦å‘æ„å»ºæµç¨‹"
          else
            echo "âŒ æ„å»ºè§¦å‘å¤±è´¥ï¼Œå“åº”å†…å®¹: $response"
            exit 1
          fi
        # ä¸­æ–‡æ³¨é‡Šï¼šæ”¹è¿›æ„å»ºè§¦å‘é€»è¾‘å¹¶å¢å¼ºè°ƒè¯•è¾“å‡º

