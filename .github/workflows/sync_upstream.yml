name: ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»“åº“

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  UPSTREAM_REPO: Ziayongyao/Sesame-TK

jobs:
  sync-check:
    runs-on: ubuntu-latest
    name: ğŸ” åŒæ­¥æ£€æŸ¥
    
    outputs:
      new_commit: ${{ steps.check_new.outputs.new_commit }}
    
    steps:
      - name: ğŸ“¦ æ£€å‡ºæœ¬åœ°ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ› ï¸ è®¾ç½® Git æƒé™
        run: |
          git config --global user.name "Sesame-TK Bot"
          git config --global user.email "bot@sesame-tk.com"

      - name: ğŸ“¥ è·å–æœ¬åœ°æäº¤è®°å½•
        run: |
          git log --pretty=format:"%H" > local_hashes.txt
          echo "æœ¬åœ°æäº¤è®°å½•å·²ä¿å­˜"

      - name: ğŸŒ è·å–ä¸Šæ¸¸æœ€æ–°æäº¤
        id: get_upstream
        run: |
          response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/commits")
          latest_hash=$(echo $response | jq -r '.[0].sha')
          echo "latest_hash=$latest_hash" >> $GITHUB_ENV
          echo "è·å–ä¸Šæ¸¸æœ€æ–°æäº¤: $latest_hash"

      - name: ğŸ” æ£€æŸ¥æ–°æäº¤
        id: check_new
        run: |
          if grep -q "$latest_hash" local_hashes.txt; then
            echo "æ— éœ€åŒæ­¥ï¼Œå·²åœ¨æœ¬åœ°å­˜åœ¨"
            echo "new_commit=false" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°æ–°æäº¤ï¼Œç»§ç»­æ‰§è¡Œ"
            echo "new_commit=true" >> $GITHUB_OUTPUT
          fi

  merge-workflow:
    runs-on: ubuntu-latest
    name: ğŸ”„ åˆ†æ”¯åˆå¹¶
    needs: sync-check
    if: ${{ needs.sync-check.outputs.new_commit == 'true' }}
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: ğŸ“¦ æ£€å‡ºä¸»åˆ†æ”¯
        uses: actions/checkout@v3
        with:
          ref: main
          path: main-branch

      - name: ğŸ§© æ£€å‡ºä¸Šæ¸¸åˆ†æ”¯
        uses: actions/checkout@v3
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: main
          path: upstream-branch
          fetch-depth: 0

      - name: ğŸ”€ åˆå¹¶ä¸Šæ¸¸æ”¹åŠ¨
        run: |
          MAIN_PATH=$GITHUB_WORKSPACE/main-branch
          UPSTREAM_PATH=$GITHUB_WORKSPACE/upstream-branch
          cd $MAIN_PATH
          git config --local user.name "Sesame-TK Bot"
          git config --local user.email "bot@sesame-tk.com"
          git remote add upstream file://$UPSTREAM_PATH
          git fetch upstream +refs/heads/*:refs/remotes/upstream/*
          git checkout -b upstream-main upstream/main
          git checkout main
          git merge --no-commit --allow-unrelated-histories \
            -s recursive -X ours upstream-main
          git checkout main -- .github/workflows/*
          git commit -m "Merge upstream changes, keep local workflows"
          git push origin main

      - name: ğŸš€ è§¦å‘æ„å»ºæµç¨‹
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build_release.yml',
              ref: 'main'
            })
