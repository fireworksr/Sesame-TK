name: 自动检测上游更新并合并

on:
  schedule:
    # 每6小时触发（UTC时间）
    - cron: '0 */6 * * *'
  workflow_dispatch: # 支持手动触发

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: 配置Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      - name: 检出主分支
        uses: actions/checkout@v2
        with:
          ref: main
          fetch-depth: 2

      - name: 获取上游提交记录
        id: get_commits
        run: |
          UPSTREAM_COMMITS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/Ziayongyao/Sesame-TK/commits" | jq -r '.[].sha')
          
          LOCAL_SHA=$(git rev-parse HEAD)
          if [[ "$UPSTREAM_COMMITS" != *"$LOCAL_SHA"* ]]; then
            echo "::set-output name=has_new::true"
          else
            echo "::set-output name=has_new::false"
            echo "没有检测到新提交"
            exit 0
          fi

      - name: 备份工作流文件
        run: |
          cp -rf .github/workflows ../workflows_backup

      - name: 执行合并
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 排除特定目录合并
          git remote add upstream https://github.com/Ziayongyao/Sesame-TK.git
          git fetch upstream
          # 使用 --exclude 参数直接排除工作流目录
          git merge --no-commit --allow-unrelated-histories -s recursive -X ours --exclude=.github/workflows upstream/main
          # 使用相对路径确保在仓库内操作
          cp -rf .github/workflows ./workflows_backup || echo "备份工作流失败"
          git checkout ./workflows_backup/.github/workflows
          git commit -am "Merge upstream changes excluding workflows"

      - name: 触发构建工作流
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: build_release.yml
          token: ${{ secrets.GITHUB_TOKEN }}
