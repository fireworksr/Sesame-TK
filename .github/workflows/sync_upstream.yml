# åŒæ­¥ä¸Šæ¸¸ä»“åº“å·¥ä½œæµ
name: ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»“åº“

on:
  # æ¯6å°æ—¶è‡ªåŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync-check:
    runs-on: ubuntu-latest
    name: ğŸ” åŒæ­¥æ£€æŸ¥
    
    steps:
      - name: ğŸ“¦ æ£€å‡ºæœ¬åœ°ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: ğŸ› ï¸ è®¾ç½® Git æƒé™
        run: |
          git config --global user.name "Sesame-TK Bot"
          git config --global user.email "bot@sesame-tk.com"
        # ä¸­æ–‡æ³¨é‡Šï¼šé…ç½® Git ç”¨æˆ·ä¿¡æ¯

      - name: ğŸ“¥ è·å–æœ¬åœ°æäº¤è®°å½•
        run: |
          git log --pretty=format:"%H" > local_hashes.txt
          echo "æœ¬åœ°æäº¤è®°å½•å·²ä¿å­˜"
        # ä¸­æ–‡æ³¨é‡Šï¼šè·å–æœ¬åœ° Git æäº¤å†å²è®°å½•ç”¨äºæ¯”å¯¹

      - name: ğŸŒ è·å–ä¸Šæ¸¸æœ€æ–°æäº¤
        id: get_upstream
        run: |
          # é€šè¿‡ GitHub API è·å–ä¸Šæ¸¸ä»“åº“æœ€æ–°æäº¤
          response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/Ziayongyao/Sesame-TK/commits")
          latest_hash=$(echo $response | jq -r '.[0].sha')
          echo "latest_hash=$latest_hash" >> $GITHUB_ENV
          echo "è·å–ä¸Šæ¸¸æœ€æ–°æäº¤: $latest_hash"
        # ä¸­æ–‡æ³¨é‡Šï¼šè°ƒç”¨ GitHub API è·å–ä¸Šæ¸¸ä»“åº“æœ€æ–°æäº¤å“ˆå¸Œ

      - name: ğŸ” æ£€æŸ¥æ–°æäº¤
        id: check_new
        run: |
          # æ£€æŸ¥ä¸Šæ¸¸å“ˆå¸Œæ˜¯å¦å­˜åœ¨äºæœ¬åœ°
          if grep -q "$latest_hash" local_hashes.txt; then
            echo "æ— éœ€åŒæ­¥ï¼Œå·²åœ¨æœ¬åœ°å­˜åœ¨"
            exit 1
          else
            echo "å‘ç°æ–°æäº¤ï¼Œç»§ç»­æ‰§è¡Œ"
            echo "new_commit=true" >> $GITHUB_ENV
          fi
        # ä¸­æ–‡æ³¨é‡Šï¼šæ¯”å¯¹æœ¬åœ°ä¸ä¸Šæ¸¸æäº¤å“ˆå¸Œ

  merge-workflow:
    runs-on: ubuntu-latest
    name: ğŸ”„ åˆ†æ”¯åˆå¹¶
    needs: sync-check
    permissions:
      contents: write  # å…è®¸è§¦å‘å·¥ä½œæµ
    
    steps:
      - name: ğŸ“¦ æ£€å‡ºä¸»åˆ†æ”¯
        uses: actions/checkout@v3
        with:
          ref: main
          path: main-branch  # æ˜¾å¼å£°æ˜è·¯å¾„

      - name: ğŸ§© æ£€å‡ºä¸Šæ¸¸åˆ†æ”¯
        uses: actions/checkout@v3
        with:
          repository: Ziayongyao/Sesame-TK
          ref: main
          path: upstream-branch  # æ˜¾å¼å£°æ˜è·¯å¾„
          fetch-depth: 0  # å¼ºåˆ¶å®Œæ•´å…‹éš†

      - name: ğŸ”€ åˆå¹¶ä¸Šæ¸¸æ”¹åŠ¨
        run: |
          # å®šä¹‰è·¯å¾„å¸¸é‡
          MAIN_PATH=$GITHUB_WORKSPACE/main-branch
          UPSTREAM_PATH=$GITHUB_WORKSPACE/upstream-branch
          
          # è¿›å…¥ä¸»åˆ†æ”¯ç›®å½•
          cd $MAIN_PATH
          
          # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
          git remote add upstream file://$UPSTREAM_PATH
          
          # è·å–ä¸Šæ¸¸å®Œæ•´å†å²
          git fetch upstream +refs/heads/*:refs/remotes/upstream/*
          
          # æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
          git branch -r
          
          # åˆ›å»ºè·Ÿè¸ªåˆ†æ”¯
          git checkout -b upstream-main upstream/main
          
          # å›åˆ°ä¸»åˆ†æ”¯
          git checkout main
          
          # æ‰§è¡Œåˆå¹¶ï¼ˆå…³é”®æ”¹è¿›ï¼‰
          git merge --no-commit --allow-unrelated-histories upstream-main
          
          # ä¿ç•™æœ¬åœ°å·¥ä½œæµæ–‡ä»¶ï¼ˆå…³é”®å†²çªè§£å†³ç­–ç•¥ï¼‰
          git checkout main -- .github/workflows/*
          git commit -m "Merge upstream changes, keep local workflows"
          
          # æ¨é€åˆå¹¶ç»“æœ
          git push origin main
        # ä¸­æ–‡æ³¨é‡Šï¼šä½¿ç”¨ --allow-unrelated-histories å‚æ•°è§£å†³å†å²æ— å…³é—®é¢˜

      - name: ğŸš€ è§¦å‘æ„å»ºæµç¨‹
        if: success()
        run: |
          # ä½¿ç”¨ GitHub API è§¦å‘æ„å»ºå·¥ä½œæµ
          curl -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/Ziayongyao/Sesame-TK/actions/workflows/build_release.yml/dispatches \
            --data '{"ref":"main"}'
        # ä¸­æ–‡æ³¨é‡Šï¼šåˆå¹¶æˆåŠŸåè§¦å‘æ„å»ºæµç¨‹
