# 同步上游仓库工作流
name: 🔄 同步上游仓库

on:
  # 每6小时自动触发
  schedule:
    - cron: '0 */6 * * *'
  # 支持手动触发
  workflow_dispatch:

jobs:
  sync-check:
    runs-on: ubuntu-latest
    name: 🔍 同步检查
    
    steps:
      - name: 📦 检出本地仓库
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取完整历史记录

      - name: 🛠️ 设置 Git 权限
        run: |
          git config --global user.name "Sesame-TK Bot"
          git config --global user.email "bot@sesame-tk.com"
        # 中文注释：配置 Git 用户信息

      - name: 📥 获取本地提交记录
        run: |
          git log --pretty=format:"%H" > local_hashes.txt
          echo "本地提交记录已保存"
        # 中文注释：获取本地 Git 提交历史记录用于比对

      - name: 🌐 获取上游最新提交
        id: get_upstream
        run: |
          # 通过 GitHub API 获取上游仓库最新提交
          response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/Ziayongyao/Sesame-TK/commits")
          latest_hash=$(echo $response | jq -r '.[0].sha')
          echo "latest_hash=$latest_hash" >> $GITHUB_ENV
          echo "获取上游最新提交: $latest_hash"
        # 中文注释：调用 GitHub API 获取上游仓库最新提交哈希

      - name: 🔍 检查新提交
        id: check_new
        run: |
          # 检查上游哈希是否存在于本地
          if grep -q "$latest_hash" local_hashes.txt; then
            echo "无需同步，已在本地存在"
            exit 1
          else
            echo "发现新提交，继续执行"
            echo "new_commit=true" >> $GITHUB_ENV
          fi
        # 中文注释：比对本地与上游提交哈希

  merge-workflow:
    runs-on: ubuntu-latest
    name: 🔄 分支合并
    needs: sync-check
    permissions:
      contents: write  # 允许触发工作流
    
    steps:
      - name: 📦 检出主分支
        uses: actions/checkout@v3
        with:
          ref: main
          path: main-branch  # 显式声明路径

      - name: 🧩 检出上游分支
        uses: actions/checkout@v3
        with:
          repository: Ziayongyao/Sesame-TK
          ref: main
          path: upstream-branch  # 显式声明路径
          fetch-depth: 0  # 强制完整克隆

      - name: 🔀 合并上游改动
        run: |
          # 定义路径常量
          MAIN_PATH=$GITHUB_WORKSPACE/main-branch
          UPSTREAM_PATH=$GITHUB_WORKSPACE/upstream-branch
          
          # 进入主分支目录
          cd $MAIN_PATH
          
          # 添加上游远程（使用绝对路径）
          git remote add upstream file://$UPSTREAM_PATH
          
          # 获取上游完整历史
          git fetch upstream +refs/heads/*:refs/remotes/upstream/*
          
          # 查看远程分支（调试用）
          git branch -r
          
          # 创建跟踪分支
          git checkout -b upstream-main upstream/main
          
          # 回到主分支
          git checkout main
          
          # 执行合并（关键改进）
          git merge --no-commit --allow-unrelated-histories upstream-main
          
          # 保留本地工作流文件（关键冲突解决策略）
          git checkout main -- .github/workflows/*
          git commit -m "Merge upstream changes, keep local workflows"
          
          # 推送合并结果
          git push origin main
        # 中文注释：使用 --allow-unrelated-histories 参数解决历史无关问题

      - name: 🚀 触发构建流程
        if: success()
        run: |
          # 使用 GitHub API 触发构建工作流
          curl -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/Ziayongyao/Sesame-TK/actions/workflows/build_release.yml/dispatches \
            --data '{"ref":"main"}'
        # 中文注释：合并成功后触发构建流程
